version: 2.
jobs:
  build:
    docker:
    - image: circleci/php:7.3-node-browsers
    - image: circleci/mysql:8.0.18-ram
      command: |
           mysqld --default-authentication-plugin=mysql_native_password
      environment:
      - APP_DEBUG: true
      - APP_ENV: testing
      - APP_KEY: base64:Bpmdn5HgX5c/k3IeuAEkhjc99cZMwm75HQNvgw5vWWo=
      - DB_CONNECTION: circle_test
      - DB_DATABASE: personal
      - DB_HOST: 127.0.0.1
      - DB_USERNAME: naoki
      - MYSQL_ALLOW_EMPTY_PASSWORD: true

      working_directory: ~/repo

    steps:
        -  checkout

        -  run: sudo apt update
        -  run: sudo docker-php-ext-install pdo_mysql

        -  restore_cache:
            keys:
                -  v1-dependencies-{{ checksum "composer.json" }} 
                -  v1-dependencies-
        -  run: composer install -n --prefer-dist 

        -  save_cache:
              key: v1-dependencies-{{ checksum "composer.json" }}
              paths:
                  -  ./vendor
                    
        -  run:  php artisan migrate --force
        -  run:  php artisan db:seed

        -  run: ./vendor/bin/phpunit
